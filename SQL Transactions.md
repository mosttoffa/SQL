## SQL Transactions 

тЬЕ <b>SQL Transactions  ржХрзА? </b> <br> 

<p>Transaction рж╣рж▓рзЛ ржПржХрж╛ржзрж┐ржХ SQL operation-ржПрж░ ржПржХржЯрж┐ рж╕рзЗржЯ, ржпрзЗржЧрзБрж▓рзЛ рж╕ржмржЧрзБрж▓рзЛ ржПржХрж╕рж╛ржерзЗ рж╕ржлрж▓ (commit) рж╣ржмрзЗ ржмрж╛ ржПржХрж╕рж╛ржерзЗ ржмрзНржпрж░рзНрже (rollback) рж╣ржмрзЗред ржПржХрзЗ ржмрж▓рзЗ тАФ "All or Nothing" ржЗржнрзЗржирзНржЯред тАЬрж╕ржм ржХрж╛ржЬ рж╣ржмрзЗ ржПржХрж╕рж╛ржерзЗ, ржирж╛ рж╣рж▓рзЗ ржХрж┐ржЫрзБржЗ рж╣ржмрзЗ ржирж╛редтАЭ
ржЕрж░рзНржерж╛рзО, ржХрзЛржирзЛ ржХрж┐ржЫрзБ рж╕ржлрж▓ ржЖрж░ ржХрзЛржирзЛ ржХрж┐ржЫрзБ ржмрзНржпрж░рзНрже тАФ ржПржоржиржЯрж┐ рж╣рждрзЗ ржкрж╛рж░ржмрзЗ ржирж╛ред Transaction рж╢рзБрж░рзБ рж╣рзЯ BEGIN TRAN ржжрж┐рзЯрзЗ ржПржмржВ рж╢рзЗрж╖ рж╣рзЯ COMMIT TRAN ржжрж┐рзЯрзЗред </p>

ЁЯОп <b>ржЙржжрзНржжрзЗрж╢рзНржп (Why Transactions are used): </b> <br> 
<p>Transactions ржмрзНржпржмрж╣рж╛рж░рзЗрж░ ржорзВрж▓ ржЙржжрзНржжрзЗрж╢рзНржп рж╣ржЪрзНржЫрзЗ ржбрзЗржЯрж╛рж░ рж╕ржарж┐ржХрждрж╛ (data integrity) ржПржмржВ consistency рж░ржХрзНрж╖рж╛ ржХрж░рж╛ред</p> <br> 
ЁЯФ╕ ржЙржжрж╛рж╣рж░ржг: 
ржзрж░рзЛ, рждрзБржорж┐ ржПржХржЯрж┐ Bank Transfer System ржмрж╛ржирж╛ржЪрзНржЫрзЛ тАФ <br> 
ЁЯТ░ A тЖТ B рждрзЗ ржЯрж╛ржХрж╛ ржЯрзНрж░рж╛ржирзНрж╕ржлрж╛рж░ рж╣ржЪрзНржЫрзЗ. ржПрж░ ржЬржирзНржп ржжрзБржЗржЯрж╛ query ржЪрж▓ржмрзЗ: <br> 
1я╕ПтГг A-ржПрж░ account ржерзЗржХрзЗ ржЯрж╛ржХрж╛ ржХржорж╛ржирзЛ <br> 
2я╕ПтГг B-ржПрж░ account-ржП ржЯрж╛ржХрж╛ ржпрзЛржЧ ржХрж░рж╛ <br> 
<pre>
UPDATE Accounts SET Balance = Balance - 500 WHERE AccountNo = 'A';
UPDATE Accounts SET Balance = Balance + 500 WHERE AccountNo = 'B';
</pre>
ЁЯСЙ ржПржЦржи ржпржжрж┐ ржорж╛ржЭржЦрж╛ржирзЗ server crash рж╣рзЯ ржмрж╛ ржжрзНржмрж┐рждрзАрзЯ query fail ржХрж░рзЗ тАФ рждрж╛рж╣рж▓рзЗ ржХрзА рж╣ржмрзЗ? <br>
тЮбя╕П A-ржПрж░ ржЯрж╛ржХрж╛ ржХржорзЗ ржпрж╛ржмрзЗ <br>
тЮбя╕П ржХрж┐ржирзНрждрзБ B ржкрж╛ржмрзЗ ржирж╛ тЭМ <br>
тЮбя╕П ржбрзЗржЯрж╛ inconsistent рж╣рзЯрзЗ ржпрж╛ржмрзЗ! <br>
ЁЯТк ржПржЗ рж╕ржорж╕рзНржпрж╛ рж░рзЛржз ржХрж░рждрзЗржЗ ржЖржорж░рж╛ Transaction ржмрзНржпржмрж╣рж╛рж░ ржХрж░рж┐ <br> <br> 
ЁЯза <b>SQL Transaction ржХрзАржнрж╛ржмрзЗ ржХрж╛ржЬ ржХрж░рзЗ: </b>  <br> 
Transaction рж╕рж╛ржзрж╛рж░ржгржд рждрж┐ржиржЯрж┐ ржзрж╛ржкрзЗ ржЪрж▓рзЗ ЁЯСЗ <br> 
<b>BEGIN TRANSACTION тЖТ Transaction рж╢рзБрж░рзБ </b> <br> 
<b>COMMIT TRANSACTION тЖТ рж╕ржм ржХрж┐ржЫрзБ рж╕ржлрж▓ рж╣рж▓рзЗ save ржХрж░рж╛ </b> <br> 
<b>ROLLBACK TRANSACTION тЖТ ржХрзЛржирзЛ рж╕ржорж╕рзНржпрж╛ рж╣рж▓рзЗ рж╕ржм ржХрж┐ржЫрзБ ржмрж╛рждрж┐рж▓ ржХрж░рж╛ </b>   <br> 

ЁЯз╛ <b>Example (Bank Transfer): </b> 
<pre>
BEGIN TRANSACTION;

UPDATE Accounts 
SET Balance = Balance - 500 
WHERE AccountNo = 'A';

UPDATE Accounts 
SET Balance = Balance + 500 
WHERE AccountNo = 'B';

-- рж╕ржмржХрж┐ржЫрзБ ржарж┐ржХржнрж╛ржмрзЗ рж╣рж▓рзЗ save ржХрж░рзЛ
COMMIT TRANSACTION;

-- ржХрзЛржирзЛ error рж╣рж▓рзЗ
ROLLBACK TRANSACTION;

тЬЕ ржпржжрж┐ ржжрзБржЗржЯрж╛ query ржарж┐ржХржнрж╛ржмрзЗ execute рж╣рзЯ тЖТ COMMIT TRANSACTION
тЭМ ржпржжрж┐ ржХрзЛржирзЛ ржПржХржЯрж╛ fail ржХрж░рзЗ тЖТ ROLLBACK TRANSACTION
</pre>

ЁЯФР <b>Transaction ржПрж░ рзкржЯрж┐ ржЧрзБржг (ACID Properties): </b> <br> 
<pre>
Property	     |           ржмрзНржпрж╛ржЦрзНржпрж╛
--------------------------------------------------------------------------
A - Atomicity	 |       ржкрзБрж░рзЛ transaction ржПржХржХ ржЗржЙржирж┐ржЯ тАУ рж╕ржм рж╣ржмрзЗ ржмрж╛ ржХрж┐ржЫрзБржЗ рж╣ржмрзЗ ржирж╛
C - Consistency	 |       Transaction рж╢рзЗрж╖рзЗ ржбрзЗржЯрж╛ valid ржЕржмрж╕рзНржерж╛рзЯ ржерж╛ржХрждрзЗ рж╣ржмрзЗ
I - Isolation	 |       ржПржХрж╛ржзрж┐ржХ transaction ржПржХрж╕рж╛ржерзЗ ржЪрж▓рж▓рзЗржУ ржПржХрзЗ ржЕржкрж░ржХрзЗ ржкрзНрж░ржнрж╛ржмрж┐ржд ржХрж░ржмрзЗ ржирж╛
D - Durability	 |       Commit рж╣рзЯрзЗ ржЧрзЗрж▓рзЗ server crash рж╣рж▓рзЗржУ ржбрзЗржЯрж╛ ржерж╛ржХржмрзЗ
</pre> 
ЁЯзй <b>Practical Example (with Error Handling): </b> <br> 
<pre>
BEGIN TRY
    BEGIN TRANSACTION;

    UPDATE Orders SET Status = 'Shipped' WHERE OrderId = 1001;
    UPDATE Inventory SET Stock = Stock - 1 WHERE ProductId = 501;

    COMMIT TRANSACTION; -- рж╕ржмржХрж┐ржЫрзБ ржарж┐ржХ ржЖржЫрзЗ тЬЕ
END TRY
BEGIN CATCH
    ROLLBACK TRANSACTION; -- ржХрзЛржирзЛ error рж╣рж▓рзЗ рж╕ржм ржмрж╛рждрж┐рж▓ тЭМ
    PRINT 'Error occurred, transaction rolled back';
END CATCH;

</pre>

<br>
ЁЯОп ржЙржжрж╛рж╣рж░ржг: <br> 
ЁЯСЙ рж╕ржорж╕рзНржпрж╛: ржПржХржЯрж┐ ржирждрзБржи order рждрзИрж░рж┐ ржХрж░рждрзЗ рж╣ржмрзЗ тАФ ржПржмржВ ржирж┐рж╢рзНржЪрж┐ржд ржХрж░рждрзЗ рж╣ржмрзЗ ржпрзЗржи Order ржПржмржВ рждрж╛рж░ OrderItems ржжрзБржЯрзЛржЗ рж╕рзЗржн рж╣рзЯ ржмрж╛ ржХрж┐ржЫрзБржЗ ржирж╛ рж╣рзЯред <br> 
<pre>
BEGIN TRAN;

INSERT INTO [Order] (OrderNumber, CustomerId, TotalAmount)
VALUES (543210, 23, 183.35);

DECLARE @OrderId INT;
SET @OrderId = SCOPE_IDENTITY();

INSERT INTO OrderItem(OrderId, ProductId, UnitPrice, Quantity)
VALUES (@OrderId, 5, 21.35, 1);

INSERT INTO OrderItem(OrderId, ProductId, UnitPrice, Quantity)
VALUES (@OrderId, 20, 81.00, 2);

COMMIT TRAN;

-- Result:
    3ржЯрж┐ рж░рзЗржХрж░рзНржб insert рж╣рзЯрзЗржЫрзЗред
ЁЯза ржХрж╛ржЬрзЗрж░ ржкрзНрж░ржХрзНрж░рж┐рзЯрж╛:
    BEGIN TRAN тЖТ Transaction рж╢рзБрж░рзБ ржХрж░рзЗ
    COMMIT TRAN тЖТ рж╕ржм ржХрж╛ржЬ рж╕ржлрж▓ рж╣рж▓рзЗ, ржЪрзВрзЬрж╛ржирзНрждржнрж╛ржмрзЗ ржбрзЗржЯрж╛ рж╕рзЗржн ржХрж░рзЗ
    ржпржжрж┐ ржХрзЛржирзЛ INSERT ржмрзНржпрж░рзНрже рж╣рзЯ, рждрж╛рж╣рж▓рзЗ рж╕ржмржЧрзБрж▓рзЛ rollback (ржмрж╛рждрж┐рж▓) рж╣рзЯрзЗ ржпрж╛рзЯ
    ржЕрж░рзНржерж╛рзО тАФ ржЖржВрж╢рж┐ржХ ржбрзЗржЯрж╛ рж╕рзЗржн рж╣ржУрзЯрж╛рж░ ржХрзЛржирзЛ рж╕рзБржпрзЛржЧ ржирзЗржЗ тЬЕ
</pre>
тЪЩя╕П <b>Transactional Commands : </b> 
<pre>
Statement	     |   Description (ржмрж╛ржВрж▓рж╛рзЯ ржмрзНржпрж╛ржЦрзНржпрж╛)
------------------------------------------------------------------------------------------------------------------------------------
BEGIN TRAN	     |       Transaction рж╢рзБрж░рзБ ржХрж░рзЗ
COMMIT TRAN	     |       Transaction рж╕ржлрж▓ржнрж╛ржмрзЗ рж╢рзЗрж╖ ржХрж░рзЗ; рж╕ржм ржбрзЗржЯрж╛ ржбрж┐рж╕рзНржХрзЗ рж╕рзЗржн ржХрж░рзЗ
ROLLBACK TRAN	 |       Transaction-ржПрж░ рж╢рзБрж░рзБ ржерзЗржХрзЗ рж╕ржм ржкрж░рж┐ржмрж░рзНрждржи ржмрж╛рждрж┐рж▓ ржХрж░рзЗ
SAVE TRAN	     |       Transaction-ржПрж░ ржоржзрзНржпрзЗ ржПржХ ржмрж╛ ржПржХрж╛ржзрж┐ржХ "save point" рждрзИрж░рж┐ ржХрж░рзЗ, ржпрзЗржЦрж╛ржирзЗ ржХрзЛржирзЛ рж╕ржорж╕рзНржпрж╛ рж╣рж▓рзЗ ржУржЗ ржкрзЯрзЗржирзНржЯ ржкрж░рзНржпржирзНржд ржлрж┐рж░рзЗ ржпрж╛ржУрзЯрж╛ ржпрж╛рзЯ
</pre> 

тЪая╕П <b>ржирзЛржЯ: </b> <br>
Transactional command рж╢рзБржзрзБржорж╛рждрзНрж░ ржирж┐ржЪрзЗрж░ statement-ржПрж░ рж╕рж╛ржерзЗ ржХрж╛ржЬ ржХрж░рзЗ: <br> 
ЁЯСЙ INSERT, UPDATE, DELETE ржПржЧрзБрж▓рзЛ DDL (ржпрзЗржоржи CREATE TABLE, DROP TABLE) ржПрж░ рж╕рж╛ржерзЗ ржХрж╛ржЬ ржХрж░рзЗ ржирж╛ред <br>  <br>


ЁЯФБ <b>Autocommit Mode ржХрзА? </b> <br> 
ржпржжрж┐ рждрзБржорж┐ BEGIN TRAN ржмрзНржпржмрж╣рж╛рж░ ржирж╛ ржХрж░рзЛ тАФ рждрж╛рж╣рж▓рзЗ SQL Server ржкрзНрж░рждрж┐ржЯрж┐ INSERT, UPDATE, DELETE statement-ржПрж░ ржкрж░ рж╕рзНржмрзЯржВржХрзНрж░рж┐рзЯржнрж╛ржмрзЗ COMMIT ржХрж░рзЗ ржжрзЗрзЯред
ржПржЯрж╛ржХрзЗ ржмрж▓рзЗ ЁЯСЙ Autocommit Modeред
рждржмрзЗ ржЕржирзЗржХ ржХрзНрж╖рзЗрждрзНрж░рзЗ explicit transaction (ржорзНржпрж╛ржирзБрзЯрж╛рж▓рж┐ рж╢рзБрж░рзБ ржХрж░рж╛) ржжрж░ржХрж╛рж░ рж╣рзЯ тАФ
ржпрзЗржоржиржГ <br> 
ЁЯТ│ ржмрзНржпрж╛ржВржХрзЗрж░ ржбрзЗржмрж┐ржЯ/ржХрзНрж░рзЗржбрж┐ржЯ ржЯрзНрж░рж╛ржирзНрж╕ржлрж╛рж░ <br> 
ЁЯЫТ ржЗ-ржХржорж╛рж░рзНрж╕рзЗрж░ ржЕрж░рзНржбрж╛рж░ ржмрж╛ ржкрзЗржорзЗржирзНржЯ рж╕рзЗржн <br> 
ржирж╛ рж╣рж▓рзЗ partial transaction рж╣рзЯрзЗ ржпрзЗрждрзЗ ржкрж╛рж░рзЗ, ржпрж╛рж░ ржлрж▓рзЗ ржЕрж╕ржорзНржкрзВрж░рзНржг ржЕрж░рзНржбрж╛рж░ ржмрж╛ ржЕрж░рзНржержирзИрждрж┐ржХ ржХрзНрж╖рждрж┐ рж╣рждрзЗ ржкрж╛рж░рзЗред <br> 
ЁЯзй ржЖрж░ржУ ржПржХржЯрж┐ Example: <br> 
рж╕ржорж╕рзНржпрж╛:
ржПржХржЯрж┐ ржирждрзБржи supplier ржПржмржВ рждрж╛рж░ products ржЧрзБрж▓рзЛ ржПржХрж╕рж╛ржерзЗ ржбрж╛ржЯрж╛ржмрзЗржЬрзЗ ржпрзЛржЧ ржХрж░рждрзЗ рж╣ржмрзЗред <br> 
<pre>
BEGIN TRAN;

INSERT INTO [Supplier] (CompanyName, ContactName, City, Country, Phone)
VALUES ('Amsterdam Broodjeshuis', 'Jan van de Berge',
        'Amsterdam', 'Netherlands','(31) 1 2612 7769');

DECLARE @SupplierId INT;
SET @SupplierId = SCOPE_IDENTITY();

INSERT INTO Product(SupplierId, ProductName, UnitPrice, Package)
VALUES (@SupplierId, 'Krentebollen', 4.35, '6 in a bag');

INSERT INTO Product(SupplierId, ProductName, UnitPrice, Package)
VALUES (@SupplierId, 'Volkoren brood', 6.35, '1 loaf');

INSERT INTO Product(SupplierId, ProductName, UnitPrice, Package)
VALUES (@SupplierId, 'Roggebrood', 2.99, '20 slices per pkgs');

COMMIT TRAN;
    
ЁЯСЙ ржПржЦрж╛ржирзЗ рж╕ржмржЧрзБрж▓рзЛ INSERT рж╕ржлрж▓ рж╣рж▓рзЗ рждржмрзЗржЗ ржбрзЗржЯрж╛ рж╕рзЗржн рж╣ржмрзЗ,
ржирж╛ рж╣рж▓рзЗ ржПржХржЯрж┐ржУ рж╣ржмрзЗ ржирж╛ред
Result: рзкржЯрж┐ рж░рзЗржХрж░рзНржб insert рж╣рзЯрзЗржЫрзЗ тЬЕ
</pre>

тЪЩя╕П <b>Where Transactions are used (Common Use Cases): </b> <br> 
<pre>
Use Case	              |          Description
-----------------------------------------------------------------------------
ЁЯТ│ Bank Transfer	            ржЯрж╛ржХрж╛ ржЯрзНрж░рж╛ржирзНрж╕ржлрж╛рж░ тАФ ржжрзБржЗ ржжрж┐ржХрзЗржЗ balance update
ЁЯЫТ E-Commerce Checkout	        Order рждрзИрж░рж┐, Payment deduct, Stock update
ЁЯПж Payroll Processing	        ржПржХрж╛ржзрж┐ржХ table update (Employee, Salary, Log)
ЁЯУж Inventory Update	            Stock increase/decrease operations
</pre>




