## SQL Transactions 

тЬЕ <b>SQL Transactions  ржХрзА? </b> <br> 

<p>Transaction рж╣рж▓рзЛ ржПржХрж╛ржзрж┐ржХ SQL operation-ржПрж░ ржПржХржЯрж┐ рж╕рзЗржЯ, ржпрзЗржЧрзБрж▓рзЛ рж╕ржмржЧрзБрж▓рзЛ ржПржХрж╕рж╛ржерзЗ рж╕ржлрж▓ (commit) рж╣ржмрзЗ ржмрж╛ ржПржХрж╕рж╛ржерзЗ ржмрзНржпрж░рзНрже (rollback) рж╣ржмрзЗред ржПржХрзЗ ржмрж▓рзЗ тАФ "All or Nothing" ржЗржнрзЗржирзНржЯред тАЬрж╕ржм ржХрж╛ржЬ рж╣ржмрзЗ ржПржХрж╕рж╛ржерзЗ, ржирж╛ рж╣рж▓рзЗ ржХрж┐ржЫрзБржЗ рж╣ржмрзЗ ржирж╛редтАЭ
ржЕрж░рзНржерж╛рзО, ржХрзЛржирзЛ ржХрж┐ржЫрзБ рж╕ржлрж▓ ржЖрж░ ржХрзЛржирзЛ ржХрж┐ржЫрзБ ржмрзНржпрж░рзНрже тАФ ржПржоржиржЯрж┐ рж╣рждрзЗ ржкрж╛рж░ржмрзЗ ржирж╛ред Transaction рж╢рзБрж░рзБ рж╣рзЯ BEGIN TRAN ржжрж┐рзЯрзЗ ржПржмржВ рж╢рзЗрж╖ рж╣рзЯ COMMIT TRAN ржжрж┐рзЯрзЗред </p>

ЁЯОп <b>ржЙржжрзНржжрзЗрж╢рзНржп (Why Transactions are used): </b> <br> 
<p>Transactions ржмрзНржпржмрж╣рж╛рж░рзЗрж░ ржорзВрж▓ ржЙржжрзНржжрзЗрж╢рзНржп рж╣ржЪрзНржЫрзЗ ржбрзЗржЯрж╛рж░ рж╕ржарж┐ржХрждрж╛ (data integrity) ржПржмржВ consistency рж░ржХрзНрж╖рж╛ ржХрж░рж╛ред</p> <br> 
ЁЯФ╕ ржЙржжрж╛рж╣рж░ржг: 
ржзрж░рзЛ, рждрзБржорж┐ ржПржХржЯрж┐ Bank Transfer System ржмрж╛ржирж╛ржЪрзНржЫрзЛ тАФ <br> 
ЁЯТ░ A тЖТ B рждрзЗ ржЯрж╛ржХрж╛ ржЯрзНрж░рж╛ржирзНрж╕ржлрж╛рж░ рж╣ржЪрзНржЫрзЗ. ржПрж░ ржЬржирзНржп ржжрзБржЗржЯрж╛ query ржЪрж▓ржмрзЗ: <br> 
1я╕ПтГг A-ржПрж░ account ржерзЗржХрзЗ ржЯрж╛ржХрж╛ ржХржорж╛ржирзЛ <br> 
2я╕ПтГг B-ржПрж░ account-ржП ржЯрж╛ржХрж╛ ржпрзЛржЧ ржХрж░рж╛ <br> 
<pre>
UPDATE Accounts SET Balance = Balance - 500 WHERE AccountNo = 'A';
UPDATE Accounts SET Balance = Balance + 500 WHERE AccountNo = 'B';
</pre>
ЁЯСЙ ржПржЦржи ржпржжрж┐ ржорж╛ржЭржЦрж╛ржирзЗ server crash рж╣рзЯ ржмрж╛ ржжрзНржмрж┐рждрзАрзЯ query fail ржХрж░рзЗ тАФ рждрж╛рж╣рж▓рзЗ ржХрзА рж╣ржмрзЗ? <br>
тЮбя╕П A-ржПрж░ ржЯрж╛ржХрж╛ ржХржорзЗ ржпрж╛ржмрзЗ <br>
тЮбя╕П ржХрж┐ржирзНрждрзБ B ржкрж╛ржмрзЗ ржирж╛ тЭМ <br>
тЮбя╕П ржбрзЗржЯрж╛ inconsistent рж╣рзЯрзЗ ржпрж╛ржмрзЗ! <br>
ЁЯТк ржПржЗ рж╕ржорж╕рзНржпрж╛ рж░рзЛржз ржХрж░рждрзЗржЗ ржЖржорж░рж╛ Transaction ржмрзНржпржмрж╣рж╛рж░ ржХрж░рж┐ <br> 
ЁЯОп ржЙржжрж╛рж╣рж░ржг: <br> 
ЁЯСЙ рж╕ржорж╕рзНржпрж╛: ржПржХржЯрж┐ ржирждрзБржи order рждрзИрж░рж┐ ржХрж░рждрзЗ рж╣ржмрзЗ тАФ ржПржмржВ ржирж┐рж╢рзНржЪрж┐ржд ржХрж░рждрзЗ рж╣ржмрзЗ ржпрзЗржи Order ржПржмржВ рждрж╛рж░ OrderItems ржжрзБржЯрзЛржЗ рж╕рзЗржн рж╣рзЯ ржмрж╛ ржХрж┐ржЫрзБржЗ ржирж╛ рж╣рзЯред <br> 
<pre>
BEGIN TRAN;

INSERT INTO [Order] (OrderNumber, CustomerId, TotalAmount)
VALUES (543210, 23, 183.35);

DECLARE @OrderId INT;
SET @OrderId = SCOPE_IDENTITY();

INSERT INTO OrderItem(OrderId, ProductId, UnitPrice, Quantity)
VALUES (@OrderId, 5, 21.35, 1);

INSERT INTO OrderItem(OrderId, ProductId, UnitPrice, Quantity)
VALUES (@OrderId, 20, 81.00, 2);

COMMIT TRAN;

-- Result:
    3ржЯрж┐ рж░рзЗржХрж░рзНржб insert рж╣рзЯрзЗржЫрзЗред
ЁЯза ржХрж╛ржЬрзЗрж░ ржкрзНрж░ржХрзНрж░рж┐рзЯрж╛:
    BEGIN TRAN тЖТ Transaction рж╢рзБрж░рзБ ржХрж░рзЗ
    COMMIT TRAN тЖТ рж╕ржм ржХрж╛ржЬ рж╕ржлрж▓ рж╣рж▓рзЗ, ржЪрзВрзЬрж╛ржирзНрждржнрж╛ржмрзЗ ржбрзЗржЯрж╛ рж╕рзЗржн ржХрж░рзЗ
    ржпржжрж┐ ржХрзЛржирзЛ INSERT ржмрзНржпрж░рзНрже рж╣рзЯ, рждрж╛рж╣рж▓рзЗ рж╕ржмржЧрзБрж▓рзЛ rollback (ржмрж╛рждрж┐рж▓) рж╣рзЯрзЗ ржпрж╛рзЯ
    ржЕрж░рзНржерж╛рзО тАФ ржЖржВрж╢рж┐ржХ ржбрзЗржЯрж╛ рж╕рзЗржн рж╣ржУрзЯрж╛рж░ ржХрзЛржирзЛ рж╕рзБржпрзЛржЧ ржирзЗржЗ тЬЕ
</pre>
тЪЩя╕П <b>Transactional Commands : </b> 
<pre>
Statement	     |   Description (ржмрж╛ржВрж▓рж╛рзЯ ржмрзНржпрж╛ржЦрзНржпрж╛)
------------------------------------------------------------------------------------------------------------------------------------
BEGIN TRAN	     |       Transaction рж╢рзБрж░рзБ ржХрж░рзЗ
COMMIT TRAN	     |       Transaction рж╕ржлрж▓ржнрж╛ржмрзЗ рж╢рзЗрж╖ ржХрж░рзЗ; рж╕ржм ржбрзЗржЯрж╛ ржбрж┐рж╕рзНржХрзЗ рж╕рзЗржн ржХрж░рзЗ
ROLLBACK TRAN	 |       Transaction-ржПрж░ рж╢рзБрж░рзБ ржерзЗржХрзЗ рж╕ржм ржкрж░рж┐ржмрж░рзНрждржи ржмрж╛рждрж┐рж▓ ржХрж░рзЗ
SAVE TRAN	     |       Transaction-ржПрж░ ржоржзрзНржпрзЗ ржПржХ ржмрж╛ ржПржХрж╛ржзрж┐ржХ "save point" рждрзИрж░рж┐ ржХрж░рзЗ, ржпрзЗржЦрж╛ржирзЗ ржХрзЛржирзЛ рж╕ржорж╕рзНржпрж╛ рж╣рж▓рзЗ ржУржЗ ржкрзЯрзЗржирзНржЯ ржкрж░рзНржпржирзНржд ржлрж┐рж░рзЗ ржпрж╛ржУрзЯрж╛ ржпрж╛рзЯ
</pre> 

тЪая╕П <b>ржирзЛржЯ: </b> <br>
Transactional command рж╢рзБржзрзБржорж╛рждрзНрж░ ржирж┐ржЪрзЗрж░ statement-ржПрж░ рж╕рж╛ржерзЗ ржХрж╛ржЬ ржХрж░рзЗ: <br> 
ЁЯСЙ INSERT, UPDATE, DELETE ржПржЧрзБрж▓рзЛ DDL (ржпрзЗржоржи CREATE TABLE, DROP TABLE) ржПрж░ рж╕рж╛ржерзЗ ржХрж╛ржЬ ржХрж░рзЗ ржирж╛ред <br> 




